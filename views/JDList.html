<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.0.1/weui.min.css">
  <title>订单中心</title>
  <style>
    .weui-form-preview__hd .weui-form-preview__value{
      font-size: 1rem!important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #p4 .weui-form-preview__value{
      color: #c54841
    }
    #p3 .weui-form-preview__value{
      color: #bd3c34
    }
    .viewMore{
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .page{
      overflow: auto;
      max-height: 96vh;
    }
    #mask{
      position:absolute;
      height: 100vh;
      width: 100vw;
      z-index: 1;
      background: rgba(0, 0, 0, .5);
      display: flex;
      justify-content: center;
      align-items: center;
      color: aliceblue;
    }
    #syncOrder{
      background: wheat;
      border: 1px solid #cccc;
    }
  </style>
</head>
<body>
  <div id="mask" style="display: none"><div>数据加载中...</div></div>
  <div class="page">
    <div class="page__hd">
      <h1 id = 'pageTitle' class="page__title">我的京东订单</h1>
      <p class="page__desc">订单预览 <span id="syncOrder" style="visibility:hidden" onclick="syncOrderList()">手动同步订单</span></p>
      <div id="nodata" style="display: none" class="weui-loadmore weui-loadmore_line">
        <span class="weui-loadmore__tips">暂无订单数据</span>
      </div>
    </div>
  </div>
  <div class="viewMore" onclick='viewMore()'>查看更多订单...</div>
  <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"> </script>
  <script type="text/javascript" src="https://res.wx.qq.com/t/wx_fed/cdn_libs/res/weui/1.2.3/weui.min.js"></script>
  <script src="/axios.js"></script>
  <script>
    let pageNum = 1;
    let pageSize = 5;
    // sku维度的有效码（-1：未知,2.无效-拆单,3.无效-取消,4.无效-京东帮帮主订单,5.无效-账号异常,6.无效-赠品类目不返佣,7.无效-校园订单,8.无效-企业订单,
    // 9.无效-团购订单,11.无效-乡村推广员下单,13.无效-违规订单,14.无效-来源与备案网址不符,15.待付款,16.已付款,17.已完成（购买用户确认收货）,
    // 20.无效-此复购订单对应的首购订单无效,21.无效-云店订单
    const statusMap = {
      2:{
        status: "无效",
        desc: "拆单"
      },
      3:{
        status: "无效",
        desc: "取消"
      },
      4:{
        status: "无效",
        desc: "京东帮帮主订单"
      },
      5:{
        status: "无效",
        desc: "账号异常"
      },
      6:{
        status: "无效",
        desc: "赠品类目不返佣"
      },
      7:{
        status: "无效",
        desc: "校园订单"
      },
      8:{
        status: "无效",
        desc: "企业订单"
      },
      9:{
        status: "无效",
        desc: "团购订单"
      },
      11:{
        status: "无效",
        desc: "乡村推广员下单"
      },
      13:{
        status: "无效",
        desc: "违规订单"
      },
      14:{
        status: "无效",
        desc: "来源与备案网址不符"
      },
      15:{
        status: "有效",
        desc: "待付款"
      },
      16:{
        status: "有效",
        desc: "已付款"
      },
      17:{
        status: "有效",
        desc: "已完成"
      },
      20:{
        status: "无效",
        desc: "此复购订单对应的首购订单无效"
      },
      21:{
        status: "无效",
        desc: "云店订单"
      },
    }
    function viewMore(){
      let domMask = document.getElementById('mask').style.display = ''
      // 获取weui
      let params = location.search.split('&')
      let weUid = params[0].split('=')[1]
      // 发送请求
      let wechat_uid = weUid
      // let wechat_uid = 'oF-RA6fbdaY0mXnMW5lzgWVlpOXM'
      if(wechat_uid === "oF-RA6fbdaY0mXnMW5lzgWVlpOXM" || wechat_uid === "oBHe40ybW1KyGblscxI4uTaGExWo"){
        let syncList = $('#syncOrder')
        syncList.attr('style', 'visibility: visible')
      }
      axios.post('/jdOrderList/get', { wechat_uid, pageNum, pageSize }).then((res)=>{
        let resultData = res.data.data
        if(resultData.length > 0){
          pageNum +=5
          document.getElementById('nodata').style.display = 'none'
          resultData.forEach(element => {
            let domPage = document.getElementsByClassName('page')
            let domDiv = document.createElement('div')
            domDiv.innerHTML = `<div class="weui-form-preview">
                <div role="option" class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">商品名称</label>
                        <em class="weui-form-preview__value">${element.skuName}</em>
                    </div>
                </div>
                <div role="option" aria-labelledby="p1 js_a11y_comma p2 js_a11y_comma p3" class="weui-form-preview__bd">
                    <div id="p1" class="weui-form-preview__item">
                      <label class="weui-form-preview__label">订单金额</label>
                      <span class="weui-form-preview__value">¥${element.estimateCosPrice}</span>
                    </div>
                    <div id="p5" class="weui-form-preview__item">
                      <label class="weui-form-preview__label">返现比率</label>
                      <span class="weui-form-preview__value">${element.commissionRate}%</span>
                    </div>
                    <div id="p3" class="weui-form-preview__item">
                      <label class="weui-form-preview__label">预估计收益</label>
                      <span class="weui-form-preview__value">¥${element.estimateFee}</span>
                    </div>
                    <div id="p4" class="weui-form-preview__item">
                      <label class="weui-form-preview__label">订单状态(${statusMap[element.validCode].status})</label>
                      <span class="weui-form-preview__value">${statusMap[element.validCode].desc}</span>
                    </div>
                </div>
              </div>`
            domPage[0].appendChild(domDiv)
          });
        }else{
          weui.alert('没有更多订单数据');
        }
        document.getElementById('mask').style.display = 'none'
      })
    }

    // 页面加载时默认加载一次订单列表
    viewMore()

    // 手动同步订单列表
    function syncOrderList(){
      axios.post('/manuaulGetOrderList/get', {}).then(res =>{
        weui.alert('手动同步成功'+res);
      })
    }
  </script>
 </body>
</html>